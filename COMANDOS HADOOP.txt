HDFS

hdfs dfs -ls /                                    Exibe o conteúdo do diretório
hdfs dfs -cat /user/Nome_arquivo                  Exibe o conteúdo do arquivo
hdfs dfs -tail /user/Nome_arquivo				  Exibe as últimas linhas de um arquivo						
hdfs dfs -mkdir									  Cria um diretório no HDFS

hdfs dfs -put <origem.txt> </destino.txt>         Copia os dados do sistema local para o HDFS (EX hdfs dfs -put input.txt /user/Carlos/input.txt)

hdfs dfs -mv
hdfs dfs -rm

hdfs dfs -rm /Sandbox_PrevencaoLavagemDinheiro/cnpj_subs_dez/Demanda\ solicitada\ 22.12.txt   (a \ serve para apagar arquivos cujos nomes contém espaços)

hdfs dfs -rmdir
hdfs dfs -setrep                      	Altera o fator de replicação de um arquivo (EX: hdfs dfs -setrep 2 /user/Carlos/input.txt)
hdfs dfs -stat                        	Informa as estatisticas de um arquivo 
hdfs dfs -fsck /                 		Check the entire filesystem and provide a lock replication summary                                
hdfs dfs -help                          Ajuda sobre o comando
hdfs dfs -du -s -h /Diretório			Verifica espaço utilizado na pasta

hdfs dfs -du -h .Trash | sort -n | egrep G      (lista o volume da lixeira do hdfs)

hdfs dfs -ls /user/nome_do_usuário/.Trash       lista o conteúdo da lixeira de um usuário

hdfs dfs -ls /user/*/.Trash						lista o conteúdo da lixeira de todos os usuários

hdfs dfs -du .Trash | sort -n					Lista os arquivos que estão na lixeira

watch hdfs dfs -du -h /RAW/COD/

watch hdfs dfs -df -h

hdfs dfs -df -h /user

hdfs dfs -du -s -h /user/svc_clouderaextcod/.Trash

hdfs dfs -rm -r -skiptrash /user/svc_clouderaextcod/.Trash/*     (usar com muito cuidado pois apaga tudo e não vai para a lixeira)

hdfs dfs -rm -r -skiptrash

hdfs dfs -rm -r /TRUSTED/ARPA/SIE/TBDWR_ARPA_RTRN_NEGC_MESA   	  (apaga e manda para a lixeira)

hdfs dfs -chown sacramento:supergroup /Sandbox_PrevencaoLavagemDinheiro/

hdfs dfsadmin -safemode get

hdfs dfsadmin -report                             List the information about HDFS on a per-datanode basis
hdfs dfsadmin -safemode get                       get a safemode status
hdfs dfsadmin -safemode enter                     Enter in mode safemode
hdfs dfsadmin -leave                              Exit the mode safemode
hdfs dfsadmin -fetchImage fsimage.backup          Perform a namenode metadata backup (must be in safemode)
hdfs dfsadmin -setSpaceQuota n-bytes somedir      Set a quota on the storage in a specific HDFS directory


VERIFICAÇÃO

hdfs dfs -getfacl hdfs://cieloha/TRUSTED/CPAY/ 

hdfs dfs -setfacl -R -m user:svc_cloudera_extre:rwx /REFINED/COD/REG/LETTER/REPORT/ANALYTICAL_VIEW/ Seta as novas configurações de forma Recursiva (-R) a todas as pastas da arvore

hdfs dfs -setfacl -R -m group:nome_grupo:rwx /REFINED/COD/REG

hdfs dfs -du -s -h /user/svc_cloudera_adm/.Trash /user/impala/.Trash

hdfs dfs -du -h -s /user/*/.Trash/*
hdfs dfs -du -h -s /user/impala/.Trash/*
hdfs dfs -du -h -s /user/impala/.Trash/* | sort -h
hdfs dfs -du -s /user/impala/.Trash/* | sort -h
hdfs dfs -du -h -s /user/impala/.Trash/* | sort -h
hdfs dfs -du -h -s /user/impala/.Trash/ | sort -h

CHECKS FOR MISSING OR CORRUPT DATABLOCKS

hdfs dfs -fsck /
hdfs dfs -fsck / -files
hdfs dfs -fsck / -files -blocks
hdfs dfs -fsck / -files -block -locations
hdfs dfs -fsck / -files -block -locations -racks

• Argumentos
hdfs dfs -r: Deletar diretório 
hdfs dfs -skipTrash: Remover permanentemente

*****Comandos para enviar dados


hdfs dfs -put <src> <dst> 				Enviar arquivo ou diretório (mais usado)
o Argumentos
-f: Sobrescreve o destino, se já existir.
-l: Força um fator de replicação

• copyFromLocal <src> <dst>
o Mover arquivo ou diretório
• Put que deleta do local
moveFromLocal <src> <dst>


*****Comandos Receber dados HDFS/Local


hdfs dfs get <src> <dst>			Receber arquivo ou diretório
• Argumento - f
• Cria um único arquivo mesclado
o getmerge <src> <dst>
o Mover para o local
• Get que deleta a cópia do HDFS
• moveToLocal <src> <localdst>


Comandos copiar e mover dados
10
o HDFS/HDFS
o Copiar arquivo ou diretório
• cp <src> <dst>
o Argumento –f
o Mover arquivo ou diretório
• mv <src> <dst>
• mv <arquivo1> <arquivo2> <arquivo3> <dst>

OBS:  Não é permitido copiar ou mover arquivos entre sistemas de arquivos



******Comandos Informações

hdfs dfs du -h <diretório>								Mostrar o uso do disco
hdfs dfs df -h <diretório>								Exibir o espaço livre
hdfs dfs stat <diretório>								Mostrar as informações do diretório
• hdfs dfs -stat %r name.txt 							#informações fator de replicação do arquivo
• hdfs dfs -stat %o name.txt 							#informações tamanho do bloco do arquivo

hdfs dfs count -h <diretório>							Contar o número de diretórios, número de arquivos e tamanho do arquivo especificado
hdfs dfs -count / 										Contar o número de diretórios, número de arquivos e tamanho do arquivo especificado
dfs dfs -count -q /										Conta o numero de cotas
hdfs dfs expunge										Esvaziar a lixeira

*****Comandos Arquivos

hdfs dfs -cat <arquivo>									Ver conteúdo do arquivo
hdfs dfs -setrep <nº repetições> <arquivo>				Alterar o fator de replicação do arquivo
hdfs dfs -touchz /user/carlos/touchteste.txt			Criar um arquivo (vazio) de registro com data e hora
hdfs dfs -checksum <arquivo>							Retornar as informações da soma de verificação de um arquivo
hdfs dfs -tail [-f] <arquivo>							Mostra o último 1KB do arquivo no console: 
hdfs dfs -tail name.txt
hdfs dfs -cat name.txt | head -n 1

*****Comandos Localização

hdfs dfs find <caminho> <procura> -print				Localiza todos os arquivos que correspondem à expressão

• Exemplos:
o hdfs dfs -find / -name data
o hdfs dfs -find / -iname Data -print
/user/semantix/input/data
o hdfs dfs -find input/ -name \*.txt -print
input/teste1.txt, input/teste2.txt

---------------------------------------------------------------------------------------------------------

SNAPSHOT

[root@slplprdbden01:10 T2007CRD]# hdfs dfs -du -h -s /TRUSTED/.
63.4 T  190.3 T  /TRUSTED

[root@slplprdbden01:10 T2007CRD]# hdfs dfs -ls /TRUSTED/.snapshot/
Found 1 items
drwxrwxrwx+  - svc_cloudera_adm supergroup          0 2022-07-23 23:00 /TRUSTED/.snapshot/cm-auto-ba277cc1-e72e-494f-a7c5-696315cd2e37_WEEKLY_2022-07-23_23-00-12
 
[root@slplprdbden01:10 T2007CRD]# hdfs dfs -du -h /TRUSTED/.snapshot/
59.0 T  177.3 T  /TRUSTED/.snapshot/cm-auto-ba277cc1-e72e-494f-a7c5-696315cd2e37_WEEKLY_2022-07-23_23-00-12
 
[root@slplprdbden01:10 T2007CRD]# hdfs dfs -du -h /REFINED/.snapshot/
8.4 T  25.3 T  /REFINED/.snapshot/cm-auto-a6306908-ab19-415c-ae26-4d8981c26a8c_WEEKLY_2022-07-23_23-01-08
 

---------------------------------------------------------------------------------------------------------

Permissões


[root@slplpprbdme01:1 conf]# getfacl pgo_client_jaas.conf
# file: pgo_client_jaas.conf
# owner: svc_cod
# group: cloudera_sentry_prd_bigdata_extratohadoop
user::rwx
group::rwx
group:cloudera_sentry_prd_bigdata_extratohadoop:rwx
mask::rwx
other::r-x

[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]# getfacl can_client_jaas.conf
# file: can_client_jaas.conf
# owner: svc_cod
# group: cloudera_sentry_prd_bigdata_extratohadoop
user::rwx
group::rwx
other::r-x

[root@slplpprbdme01:1 conf]# setfacl group:cloudera_sentry_prd_bigdata_extratohadoop:rwx can_client_jaas.conf
Usage: setfacl [-bkndRLP] { -m|-M|-x|-X ... } file ...
Try `setfacl --help' for more information.
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]# setfacl -m group:cloudera_sentry_prd_bigdata_extratohadoop:rwx can_client_jaas.conf
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]#
[root@slplpprbdme01:1 conf]# getfacl can_client_jaas.conf
# file: can_client_jaas.conf
# owner: svc_cod
# group: cloudera_sentry_prd_bigdata_extratohadoop
user::rwx
group::rwx
group:cloudera_sentry_prd_bigdata_extratohadoop:rwx
mask::rwx
other::r-x

SnapShot

[root@slplprdbden01:16 T2007CRD]# hdfs dfs -ls /.snapshot
Found 2 items
drwxrwxr-x+  - hdfs supergroup          0 2022-06-11 23:00 /.snapshot/cm-auto-4e318dc0-1f9d-4361-9360-87ed9ccc8e61_WEEKLY_2022-06-11_23-00-20
drwxr-xr-x   - hdfs supergroup          0 2017-09-12 11:43 /.snapshot/teste-snapshot


hdfs dfs -du -s -h /.snapshot/teste-snapshot
45.1 G 549.3 G /.snapshot/teste-snapshot

hdfs dfs -du -s -h /.snapshot/teste-snapshot
45.1 G 549.3 G /.snapshot/teste-snapshot

[root@slplprdbden01:10 T2007CRD]# hdfs dfs -du -h /TRUSTED/.snapshot/
59.0 T  177.3 T  /TRUSTED/.snapshot/cm-auto-ba277cc1-e72e-494f-a7c5-696315cd2e37_WEEKLY_2022-07-23_23-00-12


hdfs dfs -du -h /REFINED/.snapshot/


-----------------------------------------------------------------------------------------------------------

Verificar abort de Jobs por erros de permission deny

erro: 

Error(13): permission denied
Root cause: RemoteException: Permission denied: user=impala, access=WRITE, inode="/RAW/PRICING/PRICING/*:svc_cloudera_adm:supergroup:drwxrwxr-x

-----------------------------------------------------------------------------------------------------------

Checar as permissões do Path

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl /RAW/PRICING/PRICING
# file: /RAW/PRICING/PRICING/
#owner: svc_cloudera_adm
#group: supergroup
user::rwx
group:other:rwx
group:supergroup:rwx
mask::rwx
other::r-x
default:user::rwx
default:user:svc_cloudera_adm:rwx
default:group::rwx
default:group:other:rwx
default:mask::rwx
default:other::r-x

Nota: onde aparece default a acl se perde e não sabe qual o parametro deve seguir a solução é:

1 - Zerar as permissões com o comando abaixo:

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl -b /RAW/PRICING/PRICING

2 - Checar se as permissões foram zeradas 

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl /RAW/PRICING/PRICING
# file: /RAW/PRICING/PRICING/
#owner: svc_cloudera_adm
#group: supergroup
user::rwx
group::rwx
other::r-x

3 - Atribuir novamente as permissões para os usuários Hive, impala e o grupo cloudera_sentry_prd_bigdata_adm

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl -R -m user:impala:rwx /RAW/PRICING/PRICING

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl -R -m user:hive:rwx /RAW/PRICING/PRICING

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl -R -m group:cloudera_sentry_prd_bigdata_adm:rwx /RAW/PRICING/PRICING

4 - Checar se as permissões foram aplicadas

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -getfacl /RAW/PRICING/PRICING
# file: /RAW/PRICING/PRICING/
#owner: svc_cloudera_adm
#group: supergroup
user::rwx
user:hive:rwx
user:impala:rwx
group::rwx
group:cloudera_sentry_prd_bigdata_adm:rwx
mask::rwx
other::r-x


OBS: 

hdfs dfs -getfacl -R -m user::rwx /RAW/PRICING/PRICING    Se não for atribuído usuário entre os :: as permissões irão para user default

hdfs dfs -getfacl -R -m group::rwx /RAW/PRICING/PRICING   Se não for atribuído grupo entre os :: as permissões irão para group default

kinit -kt /keytab_svc_cloudera_adm/svc_cloudera_adm.kt svc_cloudera_adm@VISANET.COR


-----------------------------------------------------------------------------------------------------------

Limpeza da Lixeira

kinit -kt /keytab_svc_cloudera_adm/impala.keytab impala/slplprdbden01.cielo.int@VISANET.CORP && hdfs dfs -expunge

kinit -kt /keytab_svc_cloudera_adm/svc_cloudera_adm.kt svc_cloudera_adm@VISANET.CORP && hdfs dfs -expunge

-----------------------------------------------------------------------------------------------------------

Verificação de espaço utilizado em SandBoxes

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -du -s -h /sandbox/monetizacaoDeDados
74.3 G	223.0G	/sandbox/monetizacaoDeDados

Verificar a quota de uma sandbox/monetizacaoDeDados

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hadoop fs -count -q -h -v /sandbox/monetizacaoDeDados
QUOTA	REM_QUOTA	SPACE_QUOTA	REM_SPACE_QUOTA	DIR_COUNT	FILE_COUNT	CONTENT_SIZE	PATHNAME
none	inf			1T				801.0G			349			12.6K		74.3G			/sandbox/monetizacaoDeDados

Verificação de espaço livre na sandbox

[svc_cloudera_adm@slplprdbden01:20 T2007CRD]$ hdfs dfs -df -s -h /sandbox/monetizacaoDeDados
filesystem		size		Used		Available		Use%
hdfs://cieloha 	708.9T		550.1T		153.8T			78%

-----------------------------------------------------------------------------------------------------------

Rebalance de discos no datanode

https://blog.cloudera.com/how-to-use-the-new-hdfs-intra-datanode-disk-balancer-in-apache-hadoop/


hdfs diskbalancer -plan <nome FQDN do host> -thresholdPercentage 1 -bandwidth 80    (80 Mbps/s)